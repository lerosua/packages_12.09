function Inspector(h){var f={controller:null,elements:{},torrents:[]},k=function(q){var o,r,p;for(o=0;p=q[o];o++){if(!p.hasExtraInfo()){return true}}return false},n=function(){var o,p=$.map(f.torrents.slice(0),function(q){return q.getId()});if(p&&p.length){o=["id"].concat(Torrent.Fields.StatsExtra);if(k(f.torrents)){$.merge(o,Torrent.Fields.InfoExtra)}f.controller.updateTorrents(p,o)}},l=function(p){var o=p.currentTarget;if(isMobileDevice){p.stopPropagation()}$(o).addClass("selected").siblings().removeClass("selected");$("#"+o.id.replace("tab","page")).show().siblings(".inspector-page").hide();e()},e=function(){var q=f.elements,p=f.torrents,o;if(!p||!p.length){o="未选择"}else{if(p.length===1){o=p[0].getName()}else{o="选择了"+p.length+" 个任务"}}setTextContent(q.name_lb,o||na);if($(q.info_page).is(":visible")){j()}else{if($(q.peers_page).is(":visible")){updatePeersPage()}else{if($(q.trackers_page).is(":visible")){updateTrackersPage()}else{if($(q.files_page).is(":visible")){updateFilesPage()}}}}},j=function(){var J=f.torrents,aa=f.elements,z=Transmission.fmt,r="没有",y="混合",o="未知",O,B,N,I,V,D,T,W,R,w=0,F=0,H=0,M=0,q=0,G=0,L,x,X,p,K,A,U,Y,E,P,Q,Z,ab,C,S=Date.now();if(J.length<1){I=r}else{O=false;B=true;N=true;V=J[0].getStatus();for(W=0;R=J[W];++W){D=R.getStatus();if(D!=V){O=true}if(!R.isStopped()){B=N=false}if(!R.isFinished()){N=false}}if(O){I=y}else{if(N){I="完成"}else{if(B){I="暂停"}else{I=J[0].getStateString()}}}}setTextContent(aa.state_lb,I);L=I;if(J.length<1){I=r}else{V=J[0].getStatus();for(W=0;R=J[W];++W){if(!R.needsMetaData()){q+=R.getHaveUnchecked();P=R.getHaveValid();M+=P;if(R.getPieceSize()){G+=P/R.getPieceSize()}w+=R.getSizeWhenDone();F+=R.getLeftUntilDone();H+=(R.getHave())+R.getDesiredAvailable()}}ab=100*(w?(w-F)/w:1);I=z.percentString(ab);if(!q&&!F){I=z.size(M)+" (100%)"}else{if(!q){I=z.size(M)+" / "+z.size(w)+" ("+I+"%)"}else{I=z.size(M)+" / "+z.size(w)+" ("+I+"%), "+z.size(q)+" 未校验"}}}setTextContent(aa.have_lb,I);if(J.length<1){I=r}else{if(w==0){I=r}else{I=""+z.percentString((100*H)/w)+"%"}}setTextContent(aa.availability_lb,I);if(J.length<1){I=r}else{ab=Z=0;for(W=0;R=J[W];++W){ab+=R.getDownloadedEver();Z+=R.getFailedEver()}if(Z){I=z.size(ab)+" ("+z.size(Z)+" corrupt)"}else{I=z.size(ab)}}setTextContent(aa.downloaded_lb,I);if(J.length<1){I=r}else{ab=Q=0;if(J.length==1){ab=J[0].getDownloadedEver();Q=J[0].getUploadedEver();if(ab==0){ab=J[0].getHaveValid()}}else{for(W=0;R=J[W];++W){ab+=R.getDownloadedEver();Q+=R.getUploadedEver()}}I=z.size(Q)+" (分享率: "+z.ratioString(Math.ratio(Q,ab))+")"}setTextContent(aa.uploaded_lb,I);if(J.length<1){I=r}else{B=true;V=J[0].getStartDate();for(W=0;R=J[W];++W){if(V!=R.getStartDate()){V=0}if(!R.isStopped()){B=false}}if(B){I=L}else{if(!V){I=y}else{I=z.timeInterval(S/1000-V)}}}setTextContent(aa.running_time_lb,I);I="";if(J.length<1){I=r}else{V=J[0].getETA();for(W=0;R=J[W];++W){if(V!=R.getETA()){I=y;break}}}if(!I.length){if(V<0){I=o}else{I=z.timeInterval(V)}}setTextContent(aa.remaining_time_lb,I);x=-1;if(J.length<1){I=r}else{V=J[0].getLastActivity();for(W=0;R=J[W];++W){ab=R.getLastActivity();if(x<ab){x=ab}}ab=S/1000-x;if(ab<0){I=r}else{if(ab<5){I="当前活跃"}else{I=z.timeInterval(ab)+" 之前"}}}setTextContent(aa.last_activity_lb,I);if(J.length<1){I=r}else{I=J[0].getErrorString();for(W=0;R=J[W];++W){if(I!=R.getErrorString()){I=y;break}}}setTextContent(aa.error_lb,I||r);if(J.length<1){I=r}else{X=0;p=0;K=J[0].getPieceSize();for(W=0;R=J[W];++W){X+=R.getPieceCount();p+=R.getTotalSize();if(K!=R.getPieceSize()){K=0}}if(!p){I=r}else{if(K>0){I=z.size(p)+" ("+X.toStringWithCommas()+" pieces @ "+z.mem(K)+")"}else{I=z.size(p)+" ("+X.toStringWithCommas()+" pieces)"}}}setTextContent(aa.size_lb,I);if(J.length<1){I=r}else{I=J[0].getHashString();for(W=0;R=J[W];++W){if(I!=R.getHashString()){I=y;break}}}setTextContent(aa.hash_lb,I);if(J.length<1){I=r}else{V=J[0].getPrivateFlag();I=V?"当前tracker为私有 -- 已禁用DHT和PEX":"公开的";for(W=0;R=J[W];++W){if(V!=R.getPrivateFlag()){I=y;break}}}setTextContent(aa.privacy_lb,I);if(J.length<1){I=r}else{I=J[0].getComment();for(W=0;R=J[W];++W){if(I!=R.getComment()){I=y;break}}}if(!I){I=r}setTextContent(aa.comment_lb,I);if(J.length<1){I=r}else{U=false;E=false;A=J[0].getCreator();Y=J[0].getDateCreated();for(W=0;R=J[W];++W){if(A!=R.getCreator()){U=true}if(Y!=R.getDateCreated()){E=true}}if(U&&E){I=y}else{if(E&&A.length){I=A+"创建"}else{if(U&&Y){I=(new Date(Y*1000)).toDateString()+"创建"}else{I=(new Date(Y*1000)).toDateString()+" "+A+"创建"}}}}setTextContent(aa.origin_lb,I);if(J.length<1){I=r}else{I=J[0].getDownloadDir();for(W=0;R=J[W];++W){if(I!=R.getDownloadDir()){I=y;break}}}setTextContent(aa.foldername_lb,I)},c=function(o,q){var p=f.file_torrent.getId();f.controller.changeFileCommand(p,o,q)},i=function(p,o,q){c(o,q?"files-wanted":"files-unwanted")},b=function(q,o,p){var r;switch(p){case -1:r="priority-low";break;case 1:r="priority-high";break;default:r="priority-normal";break}c(o,r)},a=function(p,q,o){$(q.getElement()).siblings().slideToggle()},m=function(){$(f.elements.file_list).empty();delete f.file_torrent;delete f.file_torrent_n;delete f.file_rows},g=function(v){var t,s,q,p,w,x,y,r,o,u=[],y={children:{},file_indices:[]};q=v.getFileCount();for(t=0;t<q;++t){p=v.getFile(t).name;w=p.split("/");x=y;for(s=0;s<w.length;++s){r=w[s];o=x.children[r];if(!o){x.children[r]=o={name:r,parent:x,children:{},file_indices:[],depth:s}}x=o}x.file_index=t;delete x.children;u.push(x)}for(t=0;t<u.length;++t){x=u[t];s=x.file_index;do{x.file_indices.push(s);x=x.parent}while(x)}return y},d=function(r,q,p,o){var s;s=new FileRow(r,p.depth,p.name,p.file_indices,o%2);f.file_rows.push(s);q.appendChild(s.getElement());$(s).bind("wantedToggled",i);$(s).bind("priorityToggled",b);$(s).bind("nameClicked",a)};addSubtreeToView=function(s,r,q,p){var o,t;t=document.createElement("div");if(q.parent){d(s,t,q,p++)}if(q.children){for(o in q.children){p=addSubtreeToView(s,t,q.children[o])}}r.appendChild(t);return p},updateFilesPage=function(){var r,u,t,q,o,p=f.elements.file_list,s=f.torrents;if(s.length!==1){m();return}t=s[0];u=t?t.getFileCount():0;if(t!=f.file_torrent||u!=f.file_torrent_n){m();f.file_torrent=t;f.file_torrent_n=u;f.file_rows=[];q=document.createDocumentFragment();o=g(t);addSubtreeToView(t,q,o,0);p.appendChild(q)}else{for(r=0,u=f.file_rows.length;r<u;++r){f.file_rows[r].refresh()}}},updatePeersPage=function(){var t,r,x,q,w,s,u=[],p=Transmission.fmt,o=f.elements.peers_list,v=f.torrents;for(r=0;x=v[r];++r){q=x.getPeers();u.push('<div class="inspector_group">');if(v.length>1){u.push('<div class="inspector_torrent_label">',sanitizeText(x.getName()),"</div>")}if(!q||!q.length){u.push("<br></div>");continue}u.push('<table class="peer_list">','<tr class="inspector_peer_entry even">','<th class="encryptedCol"></th>','<th class="upCol">上传</th>','<th class="downCol">下载</th>','<th class="percentCol">%</th>','<th class="statusCol">状态</th>','<th class="addressCol">地址</th>','<th class="clientCol">客户端</th>',"</tr>");for(t=0;w=q[t];++t){s=(t%2)?"odd":"even";u.push('<tr class="inspector_peer_entry ',s,'">',"<td>",(w.isEncrypted?'<div class="encrypted-peer-cell" title="加密连接">':'<div class="unencrypted-peer-cell">'),"</div>","</td>","<td>",(w.rateToPeer?p.speedBps(w.rateToPeer):""),"</td>","<td>",(w.rateToClient?p.speedBps(w.rateToClient):""),"</td>",'<td class="percentCol">',Math.floor(w.progress*100),"%","</td>","<td>",p.peerStatus(w.flagStr),"</td>","<td>",sanitizeText(w.address),"</td>",'<td class="clientCol">',sanitizeText(w.clientName),"</td>","</tr>")}u.push("</table></div>")}setInnerHTML(o,u.join(""))},getAnnounceState=function(p){var q,o="";switch(p.announceState){case Torrent._TrackerActive:o="正在通告";break;case Torrent._TrackerWaiting:q=p.nextAnnounceTime-((new Date()).getTime()/1000);if(q<0){q=0}o="下一次通告间隔 "+Transmission.fmt.timeInterval(q);break;case Torrent._TrackerQueued:o="正在排队通告";break;case Torrent._TrackerInactive:o=p.isBackup?"用作备用Tracker":"没用通告计划";break;default:o="未知通告状态: "+p.announceState}return o},lastAnnounceStatus=function(p){var o="上次通告时间",r=["N/A"],q;if(p.hasAnnounced){q=Transmission.fmt.timestamp(p.lastAnnounceTime);if(p.lastAnnounceSucceeded){r=[q," (获得 ",Transmission.fmt.countString("peer","个节点",p.lastAnnouncePeerCount),")"]}else{o="通告错误";r=[(p.lastAnnounceResult?(p.lastAnnounceResult+" - "):""),q]}}return{label:o,value:r.join("")}},lastScrapeStatus=function(r){var o="上次更新时间",p="N/A",q;if(r.hasScraped){q=Transmission.fmt.timestamp(r.lastScrapeTime);if(r.lastScrapeSucceeded){p=q}else{o="更新错误";p=(r.lastScrapeResult?r.lastScrapeResult+" - ":"")+q}}return{label:o,value:p}},updateTrackersPage=function(){var s,q,u,B,w,z,t,p,A,x,r,v="N/A",o=f.elements.trackers_list,y=f.torrents;t=[];for(s=0;z=y[s];++s){t.push('<div class="inspector_group">');if(y.length>1){t.push('<div class="inspector_torrent_label">',z.getName(),"</div>")}u=-1;w=z.getTrackers();for(q=0;B=w[q];++q){if(u!=B.tier){if(u!==-1){t.push("</ul></div>")}u=B.tier;t.push('<div class="inspector_group_label">',"Tier ",u+1,"</div>",'<ul class="tier_list">')}A=lastAnnounceStatus(B);x=getAnnounceState(B);r=lastScrapeStatus(B);p=(q%2)?"odd":"even";t.push('<li class="inspector_tracker_entry ',p,'"><div class="tracker_host" title="',sanitizeText(B.announce),'">',sanitizeText(B.host||B.announce),"</div>",'<div class="tracker_activity">',"<div>",A.label,": ",A.value,"</div>","<div>",x,"</div>","<div>",r.label,": ",r.value,"</div>",'</div><table class="tracker_stats">',"<tr><th>做种中:</th><td>",(B.seederCount>-1?B.seederCount:v),"</td></tr>","<tr><th>下载中:</th><td>",(B.leecherCount>-1?B.leecherCount:v),"</td></tr>","<tr><th>已完成:</th><td>",(B.downloadCount>-1?B.downloadCount:v),"</td></tr>","</table></li>")}if(u!==-1){t.push("</ul></div>")}t.push("</div>")}setInnerHTML(o,t.join(""))},initialize=function(o){var p="#torrent_inspector_";f.controller=o;$(".inspector-tab").click(l);f.elements.info_page=$("#inspector-page-info")[0];f.elements.files_page=$("#inspector-page-files")[0];f.elements.peers_page=$("#inspector-page-peers")[0];f.elements.trackers_page=$("#inspector-page-trackers")[0];f.elements.file_list=$("#inspector_file_list")[0];f.elements.peers_list=$("#inspector_peers_list")[0];f.elements.trackers_list=$("#inspector_trackers_list")[0];f.elements.have_lb=$("#inspector-info-have")[0];f.elements.availability_lb=$("#inspector-info-availability")[0];f.elements.downloaded_lb=$("#inspector-info-downloaded")[0];f.elements.uploaded_lb=$("#inspector-info-uploaded")[0];f.elements.state_lb=$("#inspector-info-state")[0];f.elements.running_time_lb=$("#inspector-info-running-time")[0];f.elements.remaining_time_lb=$("#inspector-info-remaining-time")[0];f.elements.last_activity_lb=$("#inspector-info-last-activity")[0];f.elements.error_lb=$("#inspector-info-error")[0];f.elements.size_lb=$("#inspector-info-size")[0];f.elements.foldername_lb=$("#inspector-info-location")[0];f.elements.hash_lb=$("#inspector-info-hash")[0];f.elements.privacy_lb=$("#inspector-info-privacy")[0];f.elements.origin_lb=$("#inspector-info-origin")[0];f.elements.comment_lb=$("#inspector-info-comment")[0];f.elements.name_lb=$("#torrent_inspector_name")[0];e();j();updatePeersPage();updateTrackersPage();updateFilesPage()};this.setTorrents=function(o){var p=f;$(p.torrents).unbind("dataChanged.inspector");$(o).bind("dataChanged.inspector",$.proxy(e,this));p.torrents=o;clearInterval(p.refreshInterval);p.refreshInterval=setInterval($.proxy(n,this),2000);n();e()};initialize(h)};